{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã</h2>

    <div class="card">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìä –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</h5>
            <span class="badge bg-light text-dark">
                –í—Å–µ–≥–æ: {{ works|length }}
            </span>
        </div>
        <div class="card-body">
            {% if works %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞</th>
                            <th>–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                            <th>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for w in works %}
                        <tr>
                            <td><strong>#{{ w.id }}</strong></td>
                            <td>
                                <div class="fw-bold">{{ w.car.brand }}</div>
                                <small class="text-muted">{{ w.car.number }}</small>
                                <br>
                                <small class="text-info">–í–ª–∞–¥–µ–ª–µ—Ü: {{ w.car.owner.full_name }}</small>
                            </td>
                            <td>
                                <div class="fw-bold">{{ w.work_description or w.repair.description }}</div>
                                {% if w.repair.spare_parts %}
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <strong>üì¶ –ó–∞–ø—á–∞—Å—Ç–∏:</strong>
                                        {% for part in w.repair.spare_parts %}
                                            {{ part.name }} ({{ part.quantity }} —à—Ç.){% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </small>
                                </div>
                                {% endif %}
                            </td>
                            <td class="text-success fw-bold">
                                {{ helper.format_currency(w.total_cost) }}
                                {% if w.repair.spare_parts %}
                                <br>
                                <small class="text-muted">
                                    (—Ä–∞–±–æ—Ç—ã: {{ helper.format_currency(w.repair.cost) }})
                                </small>
                                {% endif %}
                            </td>
                            <td class="fw-bold">{{ w.formatted_completion_date }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('main.delete_completed_work', work_id=w.id) }}"
                                      class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')">
                                    <button type="submit" class="btn btn-danger btn-sm" title="–£–¥–∞–ª–∏—Ç—å">
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <h5>üì≠ –ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</h5>
                <p class="mb-0">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤—Å–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ -->
    {% if works %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h6>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong>–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π</strong><br>
                        –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ –æ —Ä–∞–±–æ—Ç–∞—Ö, –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –±–æ–ª–µ–µ –≥–æ–¥–∞ –Ω–∞–∑–∞–¥?
                    </p>
                    <form method="POST" action="{{ url_for('main.cleanup_works') }}">
                        <button type="submit" class="btn btn-warning"
                                onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞.')">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (—Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞)
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ works|length }}</h4>
                            <small class="text-muted">–í—Å–µ–≥–æ —Ä–∞–±–æ—Ç</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">
                                {{ helper.format_currency(works|sum(attribute='total_cost')) }}
                            </h4>
                            <small class="text-muted">–û–±—â–∏–π –¥–æ—Ö–æ–¥</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">
                            –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {{ helper.format_currency(works|sum(attribute='total_cost') / works|length if works|length > 0 else 0) }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(40, 167, 69, 0.1);
}
</style>
{% endblock %}