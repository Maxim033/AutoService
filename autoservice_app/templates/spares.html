{% extends "base.html" %}
{% block title %}–ó–∞–ø—á–∞—Å—Ç–∏{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üíæ –ó–∞–ø—á–∞—Å—Ç–∏</h2>

    <div class="row">
        <div class="col-md-8">
            <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π -->
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üì¶ –°–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π</h5>
                    <span class="badge bg-light text-dark">
                        –í—Å–µ–≥–æ: {{ spares|length }}
                    </span>
                </div>
                <div class="card-body">
                    {% if spares %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–ù–æ–º–µ—Ä</th>
                                    <th>–†–µ–º–æ–Ω—Ç</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                    <th>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for spare in spares %}
                                <tr>
                                    <td><strong>#{{ spare.id }}</strong></td>
                                    <td>
                                        <div class="fw-bold">{{ spare.name }}</div>
                                        <small class="text-muted">–¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞ #{{ spare.repair_id }}</small>
                                    </td>
                                    <td>
                                        <code class="bg-light p-1 rounded">{{ spare.number }}</code>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ spare.repair.description[:50] }}{% if spare.repair.description|length > 50 %}...{% endif %}
                                        </small>
                                        <br>
                                        <small class="text-info">
                                            {{ spare.repair.request.car.display_info }}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ spare.quantity }} —à—Ç.</span>
                                    </td>
                                    <td class="fw-bold text-success">
                                        {{ helper.format_currency(spare.total_cost) }}
                                        <br>
                                        <small class="text-muted">({{ helper.format_currency(spare.cost) }}/—à—Ç)</small>
                                    </td>
                                    <td>
                                        <small>{{ spare.formatted_installed_date }}</small>
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('main.delete_spare', spare_id=spare.id) }}"
                                              class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø—á–∞—Å—Ç—å?')">
                                            <button type="submit" class="btn btn-danger btn-sm" title="–£–¥–∞–ª–∏—Ç—å">
                                                üóëÔ∏è
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <h5>üì≠ –ù–µ—Ç –∑–∞–ø—á–∞—Å—Ç–µ–π</h5>
                        <p class="mb-0">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø—á–∞—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É —Å–ø—Ä–∞–≤–∞</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–∏ -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.spares') }}">
                        <div class="mb-3">
                            <label for="repair_id" class="form-label">–†–µ–º–æ–Ω—Ç *</label>
                            <select class="form-select" name="repair_id" id="repair_id" required
                                    onchange="updateRepairInfo(this.value)">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–º–æ–Ω—Ç...</option>
                                {% for repair in repairs %}
                                <option value="{{ repair.id }}"
                                        data-description="{{ repair.description }}"
                                        data-car="{{ repair.request.car.display_info }}"
                                        data-cost="{{ repair.cost }}">
                                    –†–µ–º–æ–Ω—Ç #{{ repair.id }} - {{ repair.request.car.display_info }}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="repairInfo" class="form-text mt-2" style="display: none;">
                                <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–º–æ–Ω—Ç–µ:</strong>
                                <div id="repairDetails" class="mt-1 p-2 bg-light rounded"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏ *</label>
                            <input type="text" class="form-control" name="name"
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–æ—Ä–º–æ–∑–Ω–æ–π –¥–∏—Å–∫" required>
                        </div>

                        <div class="mb-3">
                            <label for="number" class="form-label">–ù–æ–º–µ—Ä –∑–∞–ø—á–∞—Å—Ç–∏ *</label>
                            <input type="text" class="form-control" name="number"
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: DISC-12345" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cost" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —à—Ç. (‚ÇΩ) *</label>
                                <input type="number" step="0.01" class="form-control"
                                       name="cost" placeholder="0.00" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="quantity" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                                <input type="number" class="form-control" name="quantity"
                                       value="1" min="1" max="100" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å
                        </button>
                    </form>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ spares|length }}</h4>
                            <small class="text-muted">–í—Å–µ–≥–æ –∑–∞–ø—á–∞—Å—Ç–µ–π</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">
                                {{ helper.format_currency(spares|sum(attribute='total_cost')) }}
                            </h4>
                            <small class="text-muted">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</small>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">
                            –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ {{ (spares|map(attribute='repair_id')|unique|list)|length }} —Ä–µ–º–æ–Ω—Ç–∞—Ö
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateRepairInfo(repairId) {
    const repairInfo = document.getElementById('repairInfo');
    const repairDetails = document.getElementById('repairDetails');

    if (!repairId) {
        repairInfo.style.display = 'none';
        return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ option
    const selectedOption = document.querySelector(`#repair_id option[value="${repairId}"]`);
    if (selectedOption) {
        const description = selectedOption.getAttribute('data-description');
        const car = selectedOption.getAttribute('data-car');
        const cost = selectedOption.getAttribute('data-cost');

        repairDetails.innerHTML = `
            <div><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> ${car}</div>
            <div><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${description}</div>
            <div><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç:</strong> ${parseFloat(cost).toLocaleString('ru-RU')} ‚ÇΩ</div>
        `;
        repairInfo.style.display = 'block';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    const repairSelect = document.getElementById('repair_id');
    if (repairSelect.value) {
        updateRepairInfo(repairSelect.value);
    }
});
</script>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}
</style>
{% endblock %}