{% extends "base.html" %}
{% block title %}–†–µ–º–æ–Ω—Ç—ã{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üîß –†–µ–º–æ–Ω—Ç—ã</h2>

    <ul class="nav nav-tabs" id="repairsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="active-tab" data-bs-toggle="tab"
                    data-bs-target="#active" type="button" role="tab"
                    aria-controls="active" aria-selected="true">
                üîß –í –ø—Ä–æ—Ü–µ—Å—Å–µ ({{ active_repairs_pagination.total }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab"
                    data-bs-target="#completed" type="button" role="tab"
                    aria-controls="completed" aria-selected="false">
                ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ ({{ completed_repairs_pagination.total }})
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="repairsTabsContent">

        <!-- –í–∫–ª–∞–¥–∫–∞ 1: –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã -->
        <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>–†–µ–º–æ–Ω—Ç—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</h4>
                <div class="text-muted">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ active_repairs_pagination.page }} –∏–∑ {{ active_repairs_pagination.pages }}
                    ({{ active_repairs_pagination.total }} –≤—Å–µ–≥–æ)
                </div>
            </div>

            {% if active_display %}
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–≤–µ—Ä—Ö—É -->
            {% if active_repairs_pagination.pages > 1 %}
            <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if not active_repairs_pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('main.repairs', page=active_repairs_pagination.prev_num) }}">
                            ‚Üê –ù–∞–∑–∞–¥
                        </a>
                    </li>

                    {% for page_num in active_repairs_pagination.iter_pages() %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == active_repairs_pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('main.repairs', page=page_num) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {% if not active_repairs_pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('main.repairs', page=active_repairs_pagination.next_num) }}">
                            –í–ø–µ—Ä–µ–¥ ‚Üí
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            <table class="table table-striped table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                        <th>–ú–∞—à–∏–Ω–∞</th>
                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
                        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in active_display %}
                    <tr>
                        <td><strong>#{{ r.id }}</strong></td>
                        <td>
                            <div class="fw-bold">{{ r.description }}</div>
                            {% if r.parts_count > 0 %}
                            <small class="text-muted">üì¶ {{ r.parts_count }} –∑–∞–ø—á–∞—Å—Ç–µ–π</small>
                            {% endif %}
                        </td>
                        <td class="fw-bold">{{ r.start_date }}</td>
                        <td>{{ r.car }}</td>
                        <td>
                            {% if r.employees %}
                                <div class="employee-list">
                                    {% for emp in r.employees %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div>
                                            <span class="badge bg-info">{{ emp.full_name }}</span>
                                            <small class="text-muted">({{ emp.position }})</small>
                                        </div>
                                        <form method="POST"
                                              action="{{ url_for('main.remove_employee', repair_id=r.id, employee_id=emp.id) }}"
                                              class="d-inline"
                                              onsubmit="return confirm('–£–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {{ emp.full_name }} —Å —Ä–µ–º–æ–Ω—Ç–∞?')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">√ó</button>
                                        </form>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-muted">–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö</span>
                            {% endif %}

                            <!-- –§–æ—Ä–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
                            <form method="POST" action="{{ url_for('main.assign_employee', repair_id=r.id) }}"
                                  class="mt-2">
                                <div class="input-group input-group-sm">
                                    <select name="employee_id" class="form-select form-select-sm" required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...</option>
                                        {% for emp in employees %}
                                        <option value="{{ emp.id }}">
                                            {{ emp.full_name }} ({{ emp.position }}, —Å—Ç–∞–∂: {{ emp.experience }}–ª.)
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn btn-success btn-sm">+</button>
                                </div>
                            </form>
                        </td>
                        <td>{{ helper.format_currency(r.cost) }}</td>
                        <td>
                            <a href="{{ url_for('main.complete_repair', repair_id=r.id) }}"
                               class="btn btn-success btn-sm"
                               onclick="return confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–º–æ–Ω—Ç?')">
                                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
            {% if active_repairs_pagination.pages > 1 %}
            <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if not active_repairs_pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('main.repairs', page=active_repairs_pagination.prev_num) }}">
                            ‚Üê –ù–∞–∑–∞–¥
                        </a>
                    </li>

                    {% for page_num in active_repairs_pagination.iter_pages() %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == active_repairs_pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('main.repairs', page=page_num) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {% if not active_repairs_pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('main.repairs', page=active_repairs_pagination.next_num) }}">
                            –í–ø–µ—Ä–µ–¥ ‚Üí
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤
            </div>
            {% endif %}
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ 2: –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã -->
        <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã</h4>
                <div class="text-muted">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ completed_repairs_pagination.page }} –∏–∑ {{ completed_repairs_pagination.pages }}
                    ({{ completed_repairs_pagination.total }} –≤—Å–µ–≥–æ)
                </div>
            </div>

            {% if completed_display %}
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö -->
            {% if completed_repairs_pagination.pages > 1 %}
            <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if not completed_repairs_pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('main.repairs', completed_page=completed_repairs_pagination.prev_num) }}#completed">
                            ‚Üê –ù–∞–∑–∞–¥
                        </a>
                    </li>

                    {% for page_num in completed_repairs_pagination.iter_pages() %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == completed_repairs_pagination.page %}active{% endif %}">
                                <a class="page-link"
                                   href="{{ url_for('main.repairs', completed_page=page_num) }}#completed">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {% if not completed_repairs_pagination.has_next %}disabled{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('main.repairs', completed_page=completed_repairs_pagination.next_num) }}#completed">
                            –í–ø–µ—Ä–µ–¥ ‚Üí
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            <table class="table table-striped table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>–ú–∞—à–∏–Ω–∞</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞</th>
                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
                        <th>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for w in completed_display %}
                    <tr>
                        <td><strong>#{{ w.id }}</strong></td>
                        <td class="fw-bold">{{ w.car }}</td>
                        <td>{{ w.description }}</td>
                        <td>
                            {% if w.employees %}
                                {% for emp in w.employees %}
                                <div>
                                    <span class="badge bg-secondary mb-1">{{ emp.full_name }}</span>
                                    <small class="text-muted">({{ emp.position }})</small>
                                </div>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                            {% endif %}
                        </td>
                        <td class="text-success fw-bold">{{ helper.format_currency(w.total_cost) }}</td>
                        <td>{{ w.completion_date }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–Ω–∏–∑—É –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö -->
            {% if completed_repairs_pagination.pages > 1 %}
            <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if not completed_repairs_pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('main.repairs', completed_page=completed_repairs_pagination.prev_num) }}#completed">
                            ‚Üê –ù–∞–∑–∞–¥
                        </a>
                    </li>

                    {% for page_num in completed_repairs_pagination.iter_pages() %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == completed_repairs_pagination.page %}active{% endif %}">
                                <a class="page-link"
                                   href="{{ url_for('main.repairs', completed_page=page_num) }}#completed">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {% if not completed_repairs_pagination.has_next %}disabled{% endif %}">
                        <a class="page-link"
                           href="{{ url_for('main.repairs', completed_page=completed_repairs_pagination.next_num) }}#completed">
                            –í–ø–µ—Ä–µ–¥ ‚Üí
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ —Å AJAX —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π -->
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–µ–º–æ–Ω—Ç</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('main.repairs') }}" class="row g-3" id="repairForm">
                <div class="col-md-6">
                    <label for="request_id" class="form-label">–û–±—Ä–∞—â–µ–Ω–∏–µ *</label>
                    <select class="form-select" name="request_id" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ...</option>
                        {% for req in requests %}
                        <option value="{{ req.id }}">
                            ‚Ññ{{ req.id }} ‚Äî {{ req.car.display_info }} ({{ req.formatted_request_date }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="cost" class="form-label">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                    <div class="input-group">
                        <input type="number" step="0.01" class="form-control"
                               name="cost" placeholder="0.00" min="0">
                        <span class="input-group-text">‚ÇΩ</span>
                    </div>
                </div>
                <div class="col-12">
                    <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç *</label>
                    <textarea class="form-control" name="description"
                              placeholder="–û–ø–∏—à–∏—Ç–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —Ä–∞–±–æ—Ç—ã..."
                              rows="3" required></textarea>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏</label>
                                    <input type="text" class="form-control" id="searchInput"
                                           placeholder="–§–∞–º–∏–ª–∏—è, –∏–º—è...">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                                    <select class="form-select" id="positionFilter">
                                        <option value="">–í—Å–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</option>
                                        {% for position in positions %}
                                        <option value="{{ position }}">{{ position }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">–°—Ç–∞–∂</label>
                                    <select class="form-select" id="experienceFilter">
                                        <option value="">–õ—é–±–æ–π —Å—Ç–∞–∂</option>
                                        <option value="junior">–î–æ 3 –ª–µ—Ç (Junior)</option>
                                        <option value="middle">3-8 –ª–µ—Ç (Middle)</option>
                                        <option value="senior">–ë–æ–ª–µ–µ 8 –ª–µ—Ç (Senior)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã</label>
                                    <select class="form-select" id="scheduleFilter">
                                        <option value="">–õ—é–±–æ–π –≥—Ä–∞—Ñ–∏–∫</option>
                                        {% for schedule in schedules %}
                                        <option value="{{ schedule }}">{{ schedule }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">–ó–∞–Ω—è—Ç–æ—Å—Ç—å</label>
                                    <select class="form-select" id="availabilityFilter">
                                        <option value="">–õ—é–±–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å</option>
                                        <option value="free">–°–≤–æ–±–æ–¥–Ω—ã–µ (‚â§ 2 —Ä–µ–º–æ–Ω—Ç–∞)</option>
                                        <option value="busy">–ó–∞–Ω—è—Ç—ã–µ (> 2 —Ä–µ–º–æ–Ω—Ç–æ–≤)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted" id="employeesCount">
                                    –ù–∞–π–¥–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {{ employees|length }}
                                </small>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="resetFilters">
                                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º -->
                <div class="col-12">
                    <label class="form-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</label>
                    <div id="employeesContainer">
                        <!-- –ù–∞—á–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
                        {% if employees %}
                        <div class="row">
                            {% for emp in employees %}
                            <div class="col-md-4 mb-2">
                                <div class="card employee-card">
                                    <div class="card-body p-2">
                                        <div class="form-check">
                                            <input class="form-check-input employee-checkbox"
                                                   type="checkbox"
                                                   name="employee_ids"
                                                   value="{{ emp.id }}"
                                                   id="emp_{{ emp.id }}">
                                            <label class="form-check-label w-100" for="emp_{{ emp.id }}">
                                                <div class="fw-bold">{{ emp.full_name }}</div>
                                                <div class="small text-muted">
                                                    <div>{{ emp.position }}</div>
                                                    <div>–°—Ç–∞–∂: {{ emp.experience }} –ª–µ—Ç</div>
                                                    <div>–ì—Ä–∞—Ñ–∏–∫: {{ emp.schedule }}</div>
                                                    <div class="text-success">–ó/–ø: {{ helper.format_currency(emp.salary) }}</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        üíæ –ù–∞—á–∞—Ç—å —Ä–µ–º–æ–Ω—Ç
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.employee-list .badge {
    font-size: 0.8em;
}
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}
.pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
}
.employee-card {
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}
.employee-card:hover {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
}
.employee-card.selected {
    background-color: #e8f4ff;
    border-color: #007bff;
}
.employee-card.border-warning {
    border-color: #ffc107 !important;
    background-color: #fffbf0;
}
.loading {
    opacity: 0.6;
    pointer-events: none;
}
.availability-busy {
    color: #dc3545;
    font-weight: bold;
}
.availability-free {
    color: #198754;
}
</style>

<script>
class EmployeeFilter {
    constructor() {
        this.filters = {
            search: '',
            position: '',
            experience: '',
            schedule: '',
            availability: ''
        };
        this.init();
    }

    init() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.filters.search = e.target.value;
            this.debouncedFilter();
        });

        document.getElementById('positionFilter').addEventListener('change', (e) => {
            this.filters.position = e.target.value;
            this.filterEmployees();
        });

        document.getElementById('experienceFilter').addEventListener('change', (e) => {
            this.filters.experience = e.target.value;
            this.filterEmployees();
        });

        document.getElementById('scheduleFilter').addEventListener('change', (e) => {
            this.filters.schedule = e.target.value;
            this.filterEmployees();
        });

        document.getElementById('availabilityFilter').addEventListener('change', (e) => {
            this.filters.availability = e.target.value;
            this.filterEmployees();
        });

        document.getElementById('resetFilters').addEventListener('click', () => {
            this.resetFilters();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
        this.initCheckboxes();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tooltips
        this.initTooltips();
    }

    debouncedFilter() {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
            this.filterEmployees();
        }, 300);
    }

    async filterEmployees() {
        const container = document.getElementById('employeesContainer');
        const countElement = document.getElementById('employeesCount');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        container.classList.add('loading');

        try {
            const params = new URLSearchParams();
            if (this.filters.search) params.append('search', this.filters.search);
            if (this.filters.position) params.append('position', this.filters.position);
            if (this.filters.experience) params.append('experience', this.filters.experience);
            if (this.filters.schedule) params.append('schedule', this.filters.schedule);
            if (this.filters.availability) params.append('availability', this.filters.availability);

            const response = await fetch(`/api/employees/filter?${params}`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }

            const data = await response.json();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã
            const selectedEmployees = this.getSelectedEmployees();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            container.innerHTML = this.renderEmployees(data.employees);
            countElement.textContent = `–ù–∞–π–¥–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${data.count}`;

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã
            this.restoreSelectedEmployees(selectedEmployees);

            // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º tooltips
            this.initTooltips();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
                </div>
            `;
        } finally {
            container.classList.remove('loading');
        }
    }

    renderEmployees(employees) {
        if (employees.length === 0) {
            return `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.
                </div>
            `;
        }

        return `
            <div class="row">
                ${employees.map(emp => `
                    <div class="col-md-4 mb-2">
                        <div class="card employee-card ${emp.availability === 'busy' ? 'border-warning' : ''}">
                            <div class="card-body p-2">
                                <div class="form-check">
                                    <input class="form-check-input employee-checkbox"
                                           type="checkbox"
                                           name="employee_ids"
                                           value="${emp.id}"
                                           id="emp_${emp.id}"
                                           ${emp.availability === 'busy' ? 'data-bs-toggle="tooltip" data-bs-title="–ó–∞–Ω—è—Ç –º–Ω–æ–≥–∏–º–∏ —Ä–µ–º–æ–Ω—Ç–∞–º–∏"' : ''}>
                                    <label class="form-check-label w-100" for="emp_${emp.id}">
                                        <div class="fw-bold">${emp.full_name}</div>
                                        <div class="small text-muted">
                                            <div>${emp.position}</div>
                                            <div>–°—Ç–∞–∂: ${emp.experience} –ª–µ—Ç</div>
                                            <div>–ì—Ä–∞—Ñ–∏–∫: ${emp.schedule}</div>
                                            <div class="text-success">–ó/–ø: ${emp.formatted_salary}</div>
                                            <div class="${emp.availability === 'busy' ? 'availability-busy' : 'availability-free'}">
                                                üõ†Ô∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤: ${emp.active_repairs_count}
                                                ${emp.availability === 'busy' ? ' üî•' : ' ‚úÖ'}
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    getSelectedEmployees() {
        const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    restoreSelectedEmployees(selectedIds) {
        selectedIds.forEach(id => {
            const checkbox = document.querySelector(`.employee-checkbox[value="${id}"]`);
            if (checkbox) {
                checkbox.checked = true;
                checkbox.closest('.employee-card').classList.add('selected');
            }
        });
    }

    initCheckboxes() {
        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
        document.getElementById('employeesContainer').addEventListener('change', (e) => {
            if (e.target.classList.contains('employee-checkbox')) {
                const card = e.target.closest('.employee-card');
                if (e.target.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            }
        });
    }

    initTooltips() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    resetFilters() {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('searchInput').value = '';
        document.getElementById('positionFilter').value = '';
        document.getElementById('experienceFilter').value = '';
        document.getElementById('scheduleFilter').value = '';
        document.getElementById('availabilityFilter').value = '';

        this.filters = {
            search: '',
            position: '',
            experience: '',
            schedule: '',
            availability: ''
        };

        this.filterEmployees();
    }
}

// –ó–∞—â–∏—Ç–∞ –æ—Ç XSS - —Å–∞–Ω–∞—Ü–∏—è –≤–≤–æ–¥–∞
function sanitizeInput(input) {
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    new EmployeeFilter();

    // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∫ —Ñ–æ—Ä–º–∞–º
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        if (form.method.toLowerCase() === 'post') {
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrf_token';
                input.value = csrfToken.content;
                form.appendChild(input);
            }
        }
    });
});

// –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫–æ–¥–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('textarea, input[type="text"]');
    textareas.forEach(field => {
        field.addEventListener('input', function(e) {
            // –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ - —É–¥–∞–ª—è–µ–º –æ–ø–∞—Å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            let value = e.target.value;
            value = value.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
            value = value.replace(/javascript:/gi, '');
            value = value.replace(/on\w+=/gi, '');
            e.target.value = value;
        });
    });
});
</script>
{% endblock %}